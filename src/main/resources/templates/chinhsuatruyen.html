<!DOCTYPE html>
<html lang="vi">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Chỉnh Sửa Truyện</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<link rel="preconnect" href="https://fonts.googleapis.com/">
	<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="">
	<link href="/bootstrap.min.css" rel="stylesheet">

	<link rel="stylesheet" href="/app.css">
	<title>Demo Truyện</title>
	<meta name="description"
		content="Đọc truyện online, truyện hay. Demo Truyện luôn tổng hợp và cập nhật các chương truyện một cách nhanh nhất.">
	<style>
		.dark-theme {
			background-color: #333 !important;
			color: #fff !important;
		}

		.list-group-itemC img {
			width: 50px;
			height: 50px;
			object-fit: cover;
			border-radius: 4px;
			margin-right: 10px;
		}

		.container {
			display: flex;
			gap: 20px;
			align-items: flex-start;
		}

		.left-section,
		.right-section {
			flex: 1;
			width: 45%;
		}

		.back-button {

			color: white;
			border: none;
		}

		.title {
			font-size: 32px;

			color: white;
			padding: 10px;
			border-radius: 5px;
			text-align: center;
			margin-top: 20px;
		}

		.image-upload {
			margin-top: 20px;
		}

		.image-preview {
			margin-top: 10px;
			width: 70%;
			height: 600px;
			border: 1px solid #ccc;

			position: relative;
			overflow: hidden;
		}

		.image-preview img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			position: absolute;
			cursor: grab;
		}

		.input-field {
			width: 100%;
			padding: 8px;
			font-size: 16px;
			margin-bottom: 10px;
			border-radius: 5px;
			border: 1px solid #ccc;
		}

		#storyTitle {
			width: 100%;
		}

		.create-button {
			background-color: #4CAF50;
			color: white;
			border: none;
		}

		.cancel-button {
			background-color: #e7e7e7;
			color: black;
			border: none;
		}

		.genre-list {
			display: none;
			margin: 5px 0;
			border: 1px solid #ccc;
			border-radius: 5px;
			max-height: 150px;
			overflow-y: auto;
			background-color: #fff;
		}

		.genre-list label {
			display: block;
			padding: 5px 10px;
		}

		label {
			font-size: 18px;
			font-weight: bold;
		}

		.genre-container {
			position: relative;
			margin-bottom: 10px;
		}

		#storyGenres {
			width: 100%;
			padding: 8px;
			font-size: 16px;
			cursor: pointer;
			border-radius: 5px;
			border: 1px solid #ccc;
		}

		.selected-genres {
			margin-top: 5px;
			font-size: 16px;
			color: #555;
		}

		#storyDescription {
			width: 100%;
			height: 200px;
			padding: 8px;
			font-size: 16px;
			border-radius: 5px;
			border: 1px solid #ccc;
			resize: vertical;
			margin-bottom: 20px;
		}

		#chapterList {
			max-height: 400px;
			overflow-y: auto;
			padding: 10px;
			border: 1px solid #ccc;
			border-radius: 5px;
		}

		.chapter {
			display: flex;
			justify-content: flex-start;
			margin-bottom: 10px;
			align-items: center;
			/* Căn giữa theo chiều dọc */
			gap: 4px;
			/* Khoảng cách giữa các nút */
		}

		.chapter-title {
			flex-grow: 1;
		}

		button {
			padding: 5px 10px;
			margin-right: 5px;
			/* Thêm khoảng cách giữa các nút */
		}

		.button-group {
			display: flex;
			justify-content: center;
			/* Căn giữa các nút */
			margin-top: 20px;
		}
	</style>
</head>

<body>
	<header class="header d-none d-lg-block">
        <!-- place navbar here -->
        <nav class="navbar navbar-expand-lg navbar-dark header__navbar p-md-0">
            <div class="container">
                <a class="navbar-brand" href="/">
                    <img src="/images/gnolp.png" alt="Logo Truyen" srcset="" class="img-fluid" style="width: 100px;">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                Thể loại
                            </a>
                            <ul class="dropdown-menu dropdown-menu-custom" id="category-list">
                                <li><a class="dropdown-item" data-category="1">Ngôn Tình</a></li>
                                <li><a class="dropdown-item" data-category="2">Trọng Sinh</a></li>
                                <li><a class="dropdown-item" data-category="3">Cổ Đại</a></li>
                                <li><a class="dropdown-item" data-category="4">Tiên Hiệp</a></li>
                                <li><a class="dropdown-item" data-category="5">Ngược</a></li>
                                <li><a class="dropdown-item" data-category="6">Khác</a></li>
                                <li><a class="dropdown-item" data-category="7">Dị Giới</a></li>
                                <li><a class="dropdown-item" data-category="8">Huyền Huyễn</a></li>
                                <li><a class="dropdown-item" data-category="9">Xuyên Không</a></li>
                                <li><a class="dropdown-item" data-category="10">Sủng</a></li>
                                <li><a class="dropdown-item" data-category="11">Cung Đấu</a></li>
                                <li><a class="dropdown-item" data-category="12">Gia Đấu</a></li>
                            </ul>
                        </li>
                    </ul>





                    <div class="form-check form-switch me-3 d-flex align-items-center">
                        <label class="form-check-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"
                                class="bi bi-brightness-high" viewBox="0 0 16 16" style="fill: #fff;">
                                <path
                                    d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z">
                                </path>
                            </svg>
                        </label>
                        <input class="form-check-input theme_mode" type="checkbox"
                            style="transform: scale(1.3); margin-left: 12px; margin-right: 12px;">

                        <label class="form-check-label">
                            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 384 512"
                                style="fill: #fff;">
                                <path
                                    d="M144.7 98.7c-21 34.1-33.1 74.3-33.1 117.3c0 98 62.8 181.4 150.4 211.7c-12.4 2.8-25.3 4.3-38.6 4.3C126.6 432 48 353.3 48 256c0-68.9 39.4-128.4 96.8-157.3zm62.1-66C91.1 41.2 0 137.9 0 256C0 379.7 100 480 223.5 480c47.8 0 92-15 128.4-40.6c1.9-1.3 3.7-2.7 5.5-4c4.8-3.6 9.4-7.4 13.9-11.4c2.7-2.4 5.3-4.8 7.9-7.3c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-3.7 .6-7.4 1.2-11.1 1.6c-5 .5-10.1 .9-15.3 1c-1.2 0-2.5 0-3.7 0c-.1 0-.2 0-.3 0c-96.8-.2-175.2-78.9-175.2-176c0-54.8 24.9-103.7 64.1-136c1-.9 2.1-1.7 3.2-2.6c4-3.2 8.2-6.2 12.5-9c3.1-2 6.3-4 9.6-5.8c6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-3.6-.3-7.1-.5-10.7-.6c-2.7-.1-5.5-.1-8.2-.1c-3.3 0-6.5 .1-9.8 .2c-2.3 .1-4.6 .2-6.9 .4z">
                                </path>
                            </svg>
                        </label>
                    </div>

                    <form class="d-flex header__form-search" action="" method="GET">
                        <input class="form-control search-story" type="text" placeholder="Tìm kiếm" name="key_word"
                            value="">
                        <div class="col-12 search-result shadow no-result d-none">
                            <div class="card text-white bg-light">
                                <div class="card-body p-0">
                                    <ul class="list-group list-group-flush d-none">
                                        <li class="list-group-item">
                                            <a href="#" class="text-dark hover-title"></a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <button class="btn" type="submit">
                            <svg xmlns="http://www.w3.org/2000/svg" height="1em"
                                viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                                <path
                                    d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z">
                                </path>
                            </svg>

                        </button>
                    </form>
                    
                    <li style="float:right;">
                        <span th:if="${session.user == null}">
                            <a href="/login" class="login-button"
                                style="display: inline-block; padding: 10px 20px; background-color: #007BFF; color: white; text-decoration: none; border-radius: 5px; margin-left: 10px;">Đăng
                                nhập</a>
                        </span>
                        <span th:if="${session.user != null}">
                            <a th:href="@{/account(userId=${session.userId})}" class="welcome-button">Chào mừng, <span
                                    th:text="${session.user.firstName}"></span></a>
                            <a href="/logout" class="logout-button"
                                style="display: inline-block; padding: 10px 20px; background-color: #DC3545; color: white; text-decoration: none; border-radius: 5px; margin-left: 10px;">Đăng
                                xuất</a>
                        </span>
                    </li>
                </div>
            </div>
        </nav>
    </header>

    <div class="header-mobile d-sm-block d-lg-none">
        <nav class="navbar navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">
                    <img src="/images/gnolp.png" alt="Logo Truyen" srcset="" class="img-fluid" style="width: 100px;">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas"
                    data-bs-target="#offcanvasDarkNavbar" aria-controls="offcanvasDarkNavbar">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="offcanvas offcanvas-end text-bg-dark w-75" tabindex="-1" id="offcanvasDarkNavbar"
                    aria-labelledby="offcanvasDarkNavbarLabel">
                    <div class="offcanvas-header">
                        <img src="/images/gnolp.png" alt="Logo Truyen" srcset="" class="img-fluid" style="width: 100px;">
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"
                            aria-label="Close"></button>
                    </div>
                    <div class="offcanvas-body">
                        <ul class="navbar-nav justify-content-end flex-grow-1 pe-3 mb-3">
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                    Thể loại
                                </a>
                                <ul class="dropdown-menu dropdown-menu-custom">
                                    <li><a class="dropdown-item" data-category="13">Mạt Thế</a></li>
                                    <li><a class="dropdown-item" data-category="14">Xuyên Nhanh</a></li>
                                    <li><a class="dropdown-item" data-category="15">Hệ Thống</a></li>
                                    <li><a class="dropdown-item" data-category="16">Nữ Cường</a></li>
                                </ul>
                            </li>
                        </ul>
                        
                        <div class="form-check form-switch d-flex align-items-center mb-3 p-0">
                            <label class="form-check-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"
                                    class="bi bi-brightness-high" viewBox="0 0 16 16" style="fill: #fff;">
                                    <path
                                        d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z">
                                    </path>
                                </svg>
                            </label>
                            <input class="form-check-input theme_mode" type="checkbox"
                                style="transform: scale(1.3); margin-left: 12px; margin-right: 12px;">

                            <label class="form-check-label">
                                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" viewBox="0 0 384 512"
                                    style="fill: #fff;">
                                    <path
                                        d="M144.7 98.7c-21 34.1-33.1 74.3-33.1 117.3c0 98 62.8 181.4 150.4 211.7c-12.4 2.8-25.3 4.3-38.6 4.3C126.6 432 48 353.3 48 256c0-68.9 39.4-128.4 96.8-157.3zm62.1-66C91.1 41.2 0 137.9 0 256C0 379.7 100 480 223.5 480c47.8 0 92-15 128.4-40.6c1.9-1.3 3.7-2.7 5.5-4c4.8-3.6 9.4-7.4 13.9-11.4c2.7-2.4 5.3-4.8 7.9-7.3c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-3.7 .6-7.4 1.2-11.1 1.6c-5 .5-10.1 .9-15.3 1c-1.2 0-2.5 0-3.7 0c-.1 0-.2 0-.3 0c-96.8-.2-175.2-78.9-175.2-176c0-54.8 24.9-103.7 64.1-136c1-.9 2.1-1.7 3.2-2.6c4-3.2 8.2-6.2 12.5-9c3.1-2 6.3-4 9.6-5.8c6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-3.6-.3-7.1-.5-10.7-.6c-2.7-.1-5.5-.1-8.2-.1c-3.3 0-6.5 .1-9.8 .2c-2.3 .1-4.6 .2-6.9 .4z">
                                    </path>
                                </svg>
                            </label>
                        </div>

                        <form class="d-flex header__form-search" action="" method="GET" id="search-in-nav-collaps">
                            <input class="form-control search-story" type="text" placeholder="Tìm kiếm" name="key_word"
                                value="">
                            <div class="col-12 search-result shadow no-result d-none" id = "search-result-in-nav-collaps">
                                <div class="card text-white bg-light">
                                    <div class="card-body p-0">
                                        <ul class="list-group list-group-flush d-none">
                                            <li class="list-group-item">
                                                <a href="#" class="text-dark hover-title"></a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <button class="btn" type="submit">
                                <svg xmlns="http://www.w3.org/2000/svg" height="1em"
                                    viewBox="0 0 512 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2023 Fonticons, Inc. -->
                                    <path
                                        d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z">
                                    </path>
                                </svg>

                            </button>
                        </form>
                        
                    </div>
                </div>
            </div>
        </nav>
    </div>

    <div class="bg-light header-bottom">
        <div class="container py-1">
            <p class="mb-0">Đọc truyện online, đọc truyện chữ, truyện full, truyện hay. Tổng hợp đầy đủ và cập nhật liên
                tục.</p>
        </div>
    </div>

	<div class="header-bottom">
		<h2 class="title">Chỉnh sửa</h2>
	</div>

	<div class="container">
		<div class="left-section">
			<div class="image-upload">
				<label for="storyImage">Tải lên ảnh truyện:</label>
				<input type="file" id="uploadedImageInput" accept="image/*" onchange="previewImage(event)"><br><br>
			</div>
			<div class="image-preview" id="imagePreview">
				<img id="uploadedImage" style="display: none;">
			</div>
			<div class="chapter-list" id="chapter-list">
				<h4>Danh Sách Chương</h4>
				<!--có một mảng các chương từ backend -->
			</div>
			<div class="row">
				<div id="pagination" class="d-flex justify-content-start mt-5 flex-wrap"></div>
			</div>

		</div>

		<div class="right-section">
			<label for="storyTitle">Tên truyện:</label>
			<input type="text" id="storyTitle" class="input-field" placeholder="Nhập tên truyện"><br><br>

			<div class="genre-container">
				<label for="storyGenres">Thể loại:</label>
				<input type="text" id="storyGenres" class="input-field" placeholder="Chọn thể loại"
					onclick="toggleGenreList()" readonly>
				<div class="genre-list" id="genreList">
					<label><input type="checkbox" value="Ngôn Tình" onclick="updateGenreSelection()"> Ngôn Tình</label>
					<label><input type="checkbox" value="Trọng Sinh" onclick="updateGenreSelection()"> Trọng
						Sinh</label>
					<label><input type="checkbox" value="Cổ Đại" onclick="updateGenreSelection()"> Cổ Đại</label>
					<label><input type="checkbox" value="Tiên Hiệp" onclick="updateGenreSelection()"> Tiên Hiệp</label>
					<label><input type="checkbox" value="Ngược" onclick="updateGenreSelection()"> Ngược</label>
					<label><input type="checkbox" value="Khác" onclick="updateGenreSelection()">Khác</label>
					<label><input type="checkbox" value="Dị Giới" onclick="updateGenreSelection()"> Dị Giới</label>
					<label><input type="checkbox" value="Huyền Huyễn" onclick="updateGenreSelection()"> Huyền
						Huyễn</label>
					<label><input type="checkbox" value="Sủng" onclick="updateGenreSelection()"> Sủng</label>
					<label><input type="checkbox" value="Cung Đấu" onclick="updateGenreSelection()"> Cung Đấu</label>
					<label><input type="checkbox" value="Gia Đấu" onclick="updateGenreSelection()">Gia Đấu</label>
					<label><input type="checkbox" value="Xuyên Không" onclick="updateGenreSelection()">Xuyên
						Không</label>
					<label><input type="checkbox" value="Mạt Thế" onclick="updateGenreSelection()">Mạt Thế</label>
					<label><input type="checkbox" value="Xuyên Nhanh" onclick="updateGenreSelection()">Xuyên
						Nhanh</label>
					<label><input type="checkbox" value="Hệ Thống" onclick="updateGenreSelection()">Hệ Thống</label>
					<label><input type="checkbox" value="Nữ Cường" onclick="updateGenreSelection()">Nữ Cường</label>
				</div>
				<div id="selectedGenres" class="selected-genres"></div>
			</div><br>
			<div class="form-group">
				<label for="storyDescription">Mô tả</label>
				<textarea id="storyDescription" name="storyDescription" rows="5" required>
                    <!-- Dữ liệu mô tả sẽ được lấy từ backend -->
                </textarea>
			</div>
			<div>
				<label for="status">Trạng thái:</label>
				<select id="status" name="status">
					<option value="Hoàn thành">Hoàn thành</option>
					<option value="Còn tiếp">Còn tiếp</option>
				</select>
			</div>
		</div>
	</div>
	<div class="button-group">
		<button class="btn btn-primary" onclick="continueWriting()">Viết tiếp</button>
		<button class="btn btn-success" onclick="saveChanges()">Lưu</button>

	</div>
	<script>
		function escapeHTML(str) {
		    if (typeof str !== "string") return ""; // hoặc return String(str || "")
		    return str.replace(/[&<>"']/g, function (match) {
		        const escapeChars = {
		            '&': '&amp;',
		            '<': '&lt;',
		            '>': '&gt;',
		            '"': '&quot;',
		            "'": '&#39;'
		        };
		        return escapeChars[match];
		    });
		}
		function loadDataToDOM(data) {
			// Lấy thông tin từ JSON
			const story = data.story;
			const chapters = data.Chuong;
			console.log("danh sach chuong:", chapters);

			// Hiển thị ảnh đại diện
			const uploadedImage = document.getElementById("uploadedImage");
			if (story.srcA) {
				uploadedImage.src = story.srcA;
				uploadedImage.style.display = "block";
			}

			// Hiển thị tên truyện
			const storyTitle = document.getElementById("storyTitle");
			storyTitle.value = story.title || "";

			// Hiển thị mô tả truyện
			const storyDescription = document.getElementById("storyDescription");
			storyDescription.value = story.mo_ta || "";
			const statusSelect = document.getElementById("status");
			statusSelect.value = data.story.status;
			// Hiển thị thể loại và đánh dấu checkbox
			const storyGenres = document.getElementById("storyGenres");
			const selectedGenres = document.getElementById("selectedGenres");
			const genres = data.theloai ? data.theloai.split(",").map(genre => genre.trim()) : [];

			if (storyGenres && selectedGenres) {
				storyGenres.value = genres.join(", ");
				selectedGenres.textContent = `Thể loại đã chọn: ${genres.join(", ")}`;

				// Đánh dấu các checkbox thể loại
				const genreCheckboxes = document.querySelectorAll("#genreList input[type='checkbox']");
				genreCheckboxes.forEach(checkbox => {
					if (genres.includes(checkbox.value)) {
						checkbox.checked = true;
					} else {
						checkbox.checked = false;
					}
				});
			}

			// Hiển thị danh sách chương
			const chapterList = document.getElementById("chapter-list");

			if (chapterList) {
				chapterList.innerHTML = "<h4>Danh Sách Chương</h4>"; // Xóa nội dung cũ và thêm tiêu đề

				if (Array.isArray(chapters) && chapters.length > 0) {
					chapters.forEach((chapter, index) => {
						const chapterElement = document.createElement("div");
						chapterElement.classList.add("chapter");
						const escapedTitle = escapeHTML(chapter.title);
						const escapedContent = escapeHTML(chapter.content); // Sử dụng JSON.stringify để thoát nội dung chương
						chapterElement.innerHTML = `
		                    <span id="${chapter.id}" class="chapter-title">
		                        Chương ${chapter.number}: ${escapedTitle || `Chương ${chapter.number}`}
		                    </span>
		                    <button class="btn btn-danger btn-sm" onclick="deleteChapter(${chapter.id},${story.id})">Xóa</button>
		                    <button class="btn btn-primary btn-sm" onclick="editChapter(${chapter.id}, ${chapter.number})">Chỉnh sửa</button>`;
						chapterList.appendChild(chapterElement);
					});
				} else {
					chapterList.innerHTML += "<p>Chưa có chương nào.</p>";
				}
			}
		}
		function editChapter(id, number) {
			localStorage.setItem("number", number);
			localStorage.setItem("chapterId", id);
			localStorage.setItem("act", "edit");


			window.location.href = "/dangtruyen";
		}
		// Hàm xóa chương
		function deleteChapter(id, storyId) {
			console.log(`Yêu cầu xóa chương ${id}?id_book=${storyId}`);

			// Hiển thị hộp thoại xác nhận
			const confirmDelete = window.confirm(`Bạn có chắc chắn muốn xóa chương có ID ${id}?`);
			if (!confirmDelete) {
				console.log("Hủy xóa chương.");
				return; // Người dùng không đồng ý → dừng hàm
			}

			// Gửi yêu cầu DELETE tới backend
			fetch(`/delete-chapter/${id}?id_book=${storyId}`, {
				method: "DELETE",
				headers: {
					"Content-Type": "application/json"
				}
			})
				.then(response => {
					if (!response.ok) {
						throw new Error("Không thể xóa chương.");
					}
					return response.text();
				})
				.then(message => {
					console.log(message);

					let data = JSON.parse(localStorage.getItem("data")) || {};
					console.log("data", data);

					// Lọc bỏ chương đã xóa khỏi danh sách
					data.Chuong = data.Chuong.filter((chapter) => chapter.id !== id);

					// Cập nhật lại data trong localStorage
					localStorage.setItem("data", JSON.stringify(data));
					console.log("data new :", data);

					// Cập nhật giao diện
					const chapterElement = document.querySelector(`[id="${id}"]`)?.parentElement;
					if (chapterElement) {
						console.log("Đã xóa chương có id:", id);
						chapterElement.remove();
					}

					// Kiểm tra nếu không còn chương nào
					const chapterList = document.getElementById("chapter-list");
					if (data.Chuong.length === 0 && chapterList) {
						chapterList.innerHTML = "<p>Chưa có chương nào.</p>";
					}
				})
				.catch(error => {
					console.error("Lỗi khi xóa chương:", error);
					alert("Không thể xóa chương. Vui lòng thử lại!");
				});
		}

		// Hàm khởi tạo, tải dữ liệu từ localStorage
		function init() {
			const data = JSON.parse(localStorage.getItem("data"));
			if (data) {
				loadDataToDOM(data);
			} else {
				console.log("Không có dữ liệu trong localStorage.");
			}
		}

		// Gọi hàm init khi trang được tải xong
		document.addEventListener("DOMContentLoaded", init);







		function goBack() {
			window.history.back();
		}

		function toggleGenreList() {
			const genreList = document.getElementById('genreList');
			genreList.style.display = genreList.style.display === 'none' || genreList.style.display === '' ? 'block' : 'none';
		}

		function updateGenreSelection() {
			const genreInputs = document.querySelectorAll('.genre-list input[type="checkbox"]');
			const selectedGenres = [];

			genreInputs.forEach(input => {
				if (input.checked) {
					selectedGenres.push(input.value);
				}
			});

			const selectedGenresText = selectedGenres.join(', ');
			const selectedGenresElement = document.getElementById('selectedGenres');

			if (selectedGenresText) {
				selectedGenresElement.textContent = selectedGenresText;
				document.getElementById('storyGenres').value = selectedGenresText;
				selectedGenresElement.style.display = 'block';
			} else {
				selectedGenresElement.style.display = 'none';
			}
		}

		document.addEventListener('click', function (e) {
			const genreList = document.getElementById('genreList');
			const storyGenres = document.getElementById('storyGenres');
			const selectedGenresElement = document.getElementById('selectedGenres');

			if (!storyGenres.contains(e.target) && !genreList.contains(e.target)) {
				genreList.style.display = 'none';
				selectedGenresElement.style.display = 'none';
			}
		});

		function previewImage(event) {
			const imagePreview = document.getElementById('imagePreview');
			const img = document.getElementById('uploadedImage');
			const file = event.target.files[0];

			if (file) {
				const reader = new FileReader();
				reader.onload = function (e) {
					img.src = e.target.result;
					img.style.display = 'block';
					img.style.transform = 'scale(1)';
					img.dataset.scale = 1;
					img.style.left = '0px';
					img.style.top = '0px';

					let isDragging = false;
					let startX, startY;

					img.addEventListener('mousedown', (e) => {
						isDragging = true;
						startX = e.clientX - img.offsetLeft;
						startY = e.clientY - img.offsetTop;
						img.style.cursor = 'grabbing';
					});

					window.addEventListener('mousemove', (e) => {
						if (isDragging) {
							img.style.left = `${e.clientX - startX}px`;
							img.style.top = `${e.clientY - startY}px`;
						}
					});

					window.addEventListener('mouseup', () => {
						isDragging = false;
						img.style.cursor = 'grab';
					});

					img.addEventListener('wheel', (e) => {
						e.preventDefault();
						let scale = parseFloat(img.dataset.scale);
						const delta = e.deltaY > 0 ? -0.1 : 0.1;
						scale = Math.max(0.5, Math.min(3, scale + delta));
						img.style.transform = `scale(${scale})`;
						img.dataset.scale = scale;
					});
				}
				reader.readAsDataURL(file);
			} else {
				
			}
		}

		async function continueWriting() {
			try {
				const data = JSON.parse(localStorage.getItem("data"));
				console.log("data: ", data);

				if (!data || !data.story || !data.story.id) {
					console.error("Invalid data structure");
					return;
				}

				const book_id = data.story.id;

				// Gọi API để lấy thông tin chương tiếp theo
				const response = await fetch(`/write-continue/${book_id}`);
				if (!response.ok) {
					throw new Error("Failed to fetch chapter info");
				}

				const result = await response.json();
				console.log("API response: ", result);

				const number = result;

				// Lưu thông tin vào localStorage
				localStorage.setItem("book_id", book_id);
				localStorage.setItem("number", number);

				// Chuyển hướng đến trang viết truyện
				window.location.href = "/dangtruyen";
			} catch (error) {
				console.error("Error in continueWriting:", error);
				alert("Đã xảy ra lỗi khi tiếp tục viết chương. Vui lòng thử lại sau.");
			}
		}




		function saveChanges() {
		    const data = JSON.parse(localStorage.getItem("data"));

		    // Lấy giá trị từ các trường nhập liệu
		    const title = document.getElementById("storyTitle").value;
		    const description = document.getElementById("storyDescription").value;
		    const status = document.getElementById("status").value;

		    // Lấy danh sách thể loại đã chọn
		    const selectedGenres = [];
		    const checkboxes = document.querySelectorAll("#genreList input[type='checkbox']");
		    checkboxes.forEach((checkbox) => {
		        if (checkbox.checked) {
		            selectedGenres.push(checkbox.value);
		        }
		    });

		    // Lấy hình ảnh nếu người dùng tải lên mới
		    const imageInput = document.getElementById("uploadedImageInput"); // Giả sử input file có id này
		    const imageFile = imageInput.files.length > 0 ? imageInput.files[0] : null;

		    // Lấy thông tin truyện cũ từ localStorage
		    const author_id = data.story.author_id;
		    const story_id = data.story.id;

		    // Tạo FormData để gửi dữ liệu (thay vì JSON thuần)
		    const formData = new FormData();
		    formData.append("title", title);
		    formData.append("genres", selectedGenres.join(", ")); // Ghép thể loại thành chuỗi
		    formData.append("description", description);
		    formData.append("status", status);
		    formData.append("author_id", author_id);
		    formData.append("story_id", story_id);
			
		    // Nếu có ảnh mới, gửi ảnh; nếu không, gửi link ảnh cũ
		    if (imageFile) {
		        formData.append("image", imageFile);
		    } else {
		        formData.append("image", data.story.srcA); // Ảnh cũ
		    }

			console.log("FormData content:");
			for (const [key, value] of formData.entries()) {
			    console.log(`${key}:`, value);
			}

		    // Gửi request đến server
		    fetch("/update-truyen", {
		        method: "POST",
		        body: formData,
		    })
		        .then((response) => response.text())
		        .then((result) => {
		            if (result === "true") {
		                alert("Thay đổi đã được lưu thành công!");
		            } else {
		                alert("Có lỗi xảy ra khi lưu thay đổi!");
		            }
		        })
		        .catch((error) => {
		            console.error("Lỗi khi gửi yêu cầu:", error);
		            alert("Không thể lưu thay đổi. Vui lòng thử lại!");
		        });
		}


		function cancel() {
			if (confirm("Bạn có chắc chắn muốn hủy không?")) {
				window.location.reload();
			}
		}
	</script>
	<script src ="/js/js.js"></script>
	<script src="/jquery.min.js"></script>
	<script src="/popper.min.js"></script>
	<script src="/bootstrap.min.js"></script>
	<script src="/app.js"></script>
	<script src="/common.js"></script>

	<div id="loadingPage" class="loading-full">
		<div class="loading-full_icon">
			<div class="spinner-grow"><span class="visually-hidden">Loading...</span></div>
		</div>
	</div>
</body>

</html>